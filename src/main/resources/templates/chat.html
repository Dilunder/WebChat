<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .message {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .chat-message {
            background-color: #f8f9fa;
        }
        .system-message {
            background-color: #e9ecef;
            font-style: italic;
        }
        .join-message {
            background-color: #d4edda;
        }
        .leave-message {
            background-color: #f8d7da;
        }
        .action-message {
            background-color: #fff3cd;
        }
        .private-message {
            background-color: #cce5ff;
            border-left: 3px solid #007bff;
        }
        #onlineUsers {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .emoji-picker {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <h2>WebSocket –ß–∞—Ç</h2>

    <div class="card mb-3">
        <div class="card-header">
            <h5 class="card-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <input type="text" class="form-control" id="name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è...">
            </div>
            <button id="connect" class="btn btn-primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="disconnect" class="btn btn-danger" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <div id="chatArea" style="display: none;">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">–ß–∞—Ç</h5>
                <div id="onlineUsers"></div>
            </div>
            <div class="card-body">
                <div id="messages" class="mb-3" style="height: 400px; overflow-y: auto;"></div>

                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button class="btn btn-outline-secondary emoji-picker" type="button">üòÄ</button>
                    <button id="send" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>

                <div class="mb-3">
                    <label class="form-label">–ü—Ä–∏–≤–∞—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="recipient" placeholder="–ü–æ–ª—É—á–∞—Ç–µ–ª—å">
                        <input type="text" class="form-control" id="privateMessage" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
                        <button id="sendPrivate" class="btn btn-warning">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                </div>

                <div class="alert alert-info">
                    <small>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /help, /users, /me [–¥–µ–π—Å—Ç–≤–∏–µ]</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let username = null;
    let messageHistory = [];

    $(document).ready(function() {
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        $("#connect").click(function() {
            username = $("#name").val().trim();
            if (username) {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, function(frame) {
                    $("#connect").prop("disabled", true);
                    $("#disconnect").prop("disabled", false);
                    $("#chatArea").show();

                    // –ü–æ–¥–ø–∏—Å–∫–∏
                    stompClient.subscribe('/topic/public', function(message) {
                        const chatMessage = JSON.parse(message.body);
                        displayMessage(chatMessage);
                    });

                    stompClient.subscribe('/topic/onlineUsers', function(users) {
                        updateOnlineUsers(JSON.parse(users.body));
                    });

                    stompClient.subscribe('/user/queue/private', function(message) {
                        const chatMessage = JSON.parse(message.body);
                        displayPrivateMessage(chatMessage);
                    });

                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
                    stompClient.send("/app/chat.addUser", {},
                        JSON.stringify({'sender': username, 'type': 'JOIN'}));
                });
            }
        });

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
        $("#disconnect").click(function() {
            if (stompClient !== null) {
                stompClient.send("/app/chat.sendMessage", {},
                    JSON.stringify({'sender': username, 'content': '–ø–æ–∫–∏–Ω—É–ª —á–∞—Ç', 'type': 'LEAVE'}));

                stompClient.disconnect();
                $("#connect").prop("disabled", false);
                $("#disconnect").prop("disabled", true);
                $("#chatArea").hide();
                $("#messages").empty();
                messageHistory = [];
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        $("#send").click(sendMessage);
        $("#message").keypress(function(e) {
            if (e.which === 13) sendMessage();
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        $("#sendPrivate").click(sendPrivateMessage);
        $("#privateMessage").keypress(function(e) {
            if (e.which === 13) sendPrivateMessage();
        });

        // –≠–º–æ–¥–∑–∏
        $(".emoji-picker").click(function() {
            const emojis = ["üòÄ", "üòÇ", "üòç", "üëç", "üëã", "‚ù§Ô∏è", "üéâ", "ü§î"];
            const emojiPicker = $("<div>").css({
                position: 'absolute',
                background: 'white',
                border: '1px solid #ddd',
                padding: '5px',
                'z-index': '1000'
            });

            emojis.forEach(emoji => {
                $("<span>").text(emoji).css({
                    margin: '5px',
                    cursor: 'pointer'
                }).click(function() {
                    $("#message").val($("#message").val() + emoji);
                    emojiPicker.remove();
                }).appendTo(emojiPicker);
            });

            emojiPicker.insertAfter($(this));
        });

        function sendMessage() {
            const messageContent = $("#message").val().trim();
            if (messageContent && username) {
                const chatMessage = {
                    'sender': username,
                    'content': messageContent,
                    'type': 'CHAT'
                };

                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                $("#message").val("");
            }
        }

        function sendPrivateMessage() {
            const recipient = $("#recipient").val().trim();
            const messageContent = $("#privateMessage").val().trim();

            if (recipient && messageContent && username) {
                const chatMessage = {
                    'sender': username,
                    'content': messageContent,
                    'type': 'PRIVATE',
                    'recipient': recipient
                };
                stompClient.send("/app/chat.private", {}, JSON.stringify(chatMessage));
                displayPrivateMessage({
                    'sender': username,
                    'content': messageContent,
                    'type': 'PRIVATE',
                    'recipient': recipient
                });

                $("#privateMessage").val("");
            }
        }

        function displayMessage(message) {
            const messagesDiv = $("#messages");
            let messageClass = 'chat-message';

            switch(message.type) {
                case 'JOIN': messageClass = 'join-message'; break;
                case 'LEAVE': messageClass = 'leave-message'; break;
                case 'SYSTEM': messageClass = 'system-message'; break;
                case 'ACTION': messageClass = 'action-message'; break;
            }

            const messageElement = $("<div>").addClass("message " + messageClass)
                .html(<strong>${message.sender}:</strong> ${message.content});

            messagesDiv.append(messageElement);
            messagesDiv.scrollTop(messagesDiv[0].scrollHeight);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            messageHistory.push(message);
            if (messageHistory.length > 100) messageHistory.shift();
        }

        function displayPrivateMessage(message) {
            const messagesDiv = $("#messages");
            const messageElement = $("<div>").addClass("message private-message")
                .html(<strong>${message.sender} ‚Üí ${message.recipient || '–≤–∞–º'}:</strong> ${message.content});

            messagesDiv.append(messageElement);
            messagesDiv.scrollTop(messagesDiv[0].scrollHeight);
            messageHistory.push(message);
        }

        function updateOnlineUsers(users) {
            $("#onlineUsers").html(<strong>–û–Ω–ª–∞–π–Ω (${users.length}):</strong> ${users.join(', ')});
        }
    });
</script>
</body>
</html>